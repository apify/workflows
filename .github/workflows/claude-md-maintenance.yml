name: Claude MD Maintenance (reusable)

on:
  workflow_dispatch:
  workflow_call:
    secrets:
      ANTHROPIC_API_KEY:
        required: true

permissions:
  contents: write
  pull-requests: write

jobs:
  update-claude-md:
    name: Generate / update CLAUDE.md
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Generate CLAUDE.md
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          CLAUDE_CODE_NON_INTERACTIVE: "1"
        run: |
          PROMPT=$(cat .github/prompts/claude-md-system-prompt.md)
          claude --dangerously-skip-permissions --verbose -p "$PROMPT"

      - name: Check for changes
        id: diff
        run: |
          if git ls-files --others --exclude-standard CLAUDE.md | grep -q . || ! git diff --quiet CLAUDE.md 2>/dev/null; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create PR with updated CLAUDE.md
        if: steps.diff.outputs.changed == 'true'
        id: create-pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          BRANCH="chore/update-claude-md-$(date +%Y%m%d%H%M%S)"
          git checkout -b "$BRANCH"
          git add CLAUDE.md
          git commit -m "docs: update CLAUDE.md [skip ci]"
          git push origin "$BRANCH"
          PR_URL=$(gh pr create \
            --title "docs: update CLAUDE.md" \
            --body "Automated update of CLAUDE.md generated by the Claude MD Maintenance workflow." \
            --base "${{ github.ref_name }}" \
            --head "$BRANCH")
          echo "pr_url=$PR_URL" >> "$GITHUB_OUTPUT"

      - name: Assign PR and request review
        if: steps.create-pr.outputs.pr_url != ''
        continue-on-error: true
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr edit "${{ steps.create-pr.outputs.pr_url }}" \
            --add-assignee "${{ github.actor }}"
          gh pr edit "${{ steps.create-pr.outputs.pr_url }}" \
            --add-reviewer "${{ github.actor }}"
